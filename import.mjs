// jsonstat-suite v3.0.0 Copyright 2019 Xavier Badosa https://jsonstat.com
function e(e,t){return null==e?null:("string"!=typeof e&&void 0!==e.length||(e=JSONstat(e)),0===e.length||"dataset"!==e.class&&"collection"!==e.class&&"bundle"!==e.class?null:"dataset"===e.class?e:e.Dataset(t))}function t(e){if(null===e||0===e.length||"dataset"!==e.class)return!1;for(var t=e.length,n=1;t--;)n*=e.Dimension(t).length;return n===e.n}function n(e,t,n){var l,a,r,i,o;return(t.label||n).capitalize()+(a=t,o="",(l=e)&&"metric"===l.role&&a.unit&&(r=a.unit.hasOwnProperty("label")?a.unit.label:"")+(i=a.unit.hasOwnProperty("symbol")?a.unit.symbol:"")!==""&&(o=" ("+(o=""===i?r:""===r?i:"start"===a.unit.position?i+r:r+" "+i)+")"),o)}function l(e,t,l){var a,r='<select name="'+t+'">',i=[];if(null!==l[1]){if(a=e.id,i=e.Dimension(),2===a.length)return(e.Dimension(l[0]).label||l[0]).capitalize()}else{var o=e.Dimension(t);if(a=o.id,i=o.Category(),1===a.length)return}return a.forEach((function(e,t){var a=e!==l[0]?"":'selected="selected" ';null!==l[1]&&e===l[1]||(r+="<option "+a+'value="'+e+'">'+n(o,i[t],e)+"</option>")})),r+="</select>"}function a(a,r,i){function o(e){void 0!==r?r.innerHTML=s[e]:window.alert(s[e])}if(void 0!==a)if(void 0!==r){void 0===i&&(i={});var s=void 0===i.i18n||void 0===i.i18n.msgs?{urierror:"tbrowser: A valid JSON-stat input must be specified.",selerror:"tbrowser: A valid selector must be specified.",jsonerror:"The request did not return a valid JSON-stat dataset.",dimerror:"Only one dimension was found in the dataset. At least two are required.",dataerror:"Selection returned no data!",source:"Source",filters:"Filters",constants:"Constants",rc:"Rows &amp; Columns",na:"n/a"}:i.i18n.msgs,u=void 0===i.i18n||void 0===i.i18n.locale?"en-US":i.i18n.locale,c=i.dsid||0,d=i.status||!1,f=i.tblclass||"",h=i.nonconst||!1,v=e(a,c);if(t(v)){if(h)var p=function(e){var t=0,n=e.size.slice(0),l=[];return n.forEach((function(n,a){var r=a-t,i=e.Dimension(r);1===n&&(delete e.__tree__.dimension[e.id[r]],e.size.splice(r,1),e.id.splice(r,1),e.length--,t++,l.push(i.label.capitalize()+": "+i.Category(0).label.capitalize()))})),l}(v);1!==v.length?function e(t,a,r,i){var o="",c="",f="",v="",b=r.rows,g=a.Dimension(b),m=g.id,y=r.cols,O=a.Dimension(y),w=O.id,E=a.role&&a.role.metric?a.role.metric[0]:null,S=null!==E?a.Dimension(E):null,x=function(e){return e.hasOwnProperty("unit")&&e.unit&&e.unit.hasOwnProperty("decimals")?e.unit.decimals:null},A=r.filter,D=JSON.parse(JSON.stringify(A)),P=[],N="",j="",z=a.source?s.source+": "+a.source:"",R=null!==a.label?'<span class="label">'+a.label.capitalize()+"</span>":"";for(var C in h&&p.length&&(R='<span class="label">'+p.join(". ")+"</span>"),""!==z&&"."!==z.slice(-1)&&(z+="."),f+="<caption>"+R+"<form>",A){var T=a.Dimension(C),_=T.label?T.label.capitalize():C.capitalize();T.length>1?N+="<p>"+l(a,C,[A[C],null])+" <strong>"+_+"</strong></p>":P.push({label:_,value:n(T,T.Category(0)),name:C,id:T.id[0]})}""!==N&&(N='<fieldset id="filters"><legend>'+s.filters+"</legend>"+N+"</fieldset>"),P.forEach((function(e){j+="<p>"+e.value+" <strong>"+e.label+'</strong></p><input type="hidden" name="'+e.name+'" value="'+e.id+'" />'})),""!==j&&(j='<fieldset id="constants"><legend>'+s.constants+"</legend>"+j+"</fieldset>"),f+=j+N+'<fieldset id="rowscols"><legend>'+s.rc+"</legend>"+l(a,"rows",[b,y])+" <a>&#x2194;</a> "+l(a,"cols",[y,b])+"</fieldset></form></caption>",v+="<tbody>";var J=Number.toLocaleString?function(e,t){return null===t?e.toLocaleString(u):e.toLocaleString(u,{minimumFractionDigits:t,maximumFractionDigits:t})}:function(e,t){return null===t?e:e.toFixed(t)};if(m.forEach((function(e){D[b]=e;var t=a.Data(D),l=function(e,t){var n,l=y!==E?null===S?null:x(S.Category(D[E])):x(O.Category(t));null!==e.value?(n=J(e.value,l),d&&null!==e.status&&(n+=" ("+e.status+")")):n=e.status||s.na,v+="<td>"+n+"</td>"};null!==t?(v+='<tr><th scope="row">'+n(g,g.Category(e))+"</th>",Array.isArray(t)?t.forEach((function(e,t){l(e,t)})):l(t,0),v+="</tr>"):v="ERROR"})),"ERROR"===v)return s.dataerror;v+="</tbody>",o+="<thead><tr><th></th>",w.forEach((function(e){o+='<th scope="col">'+n(O,O.Category(e))+"</th>"})),o+="</tr></thead>",""!==z&&(c='<tfoot><tr><td colspan="'+(w.length+1)+'">'+z+"</td></tr></tfoot>"),t.innerHTML='<table class="'+i+'">'+f+o+c+v+"</table>",[].slice.call(t.querySelectorAll("select")).forEach((function(n){n.addEventListener("change",(function(n){var l,r;e(t,a,function(e,t,n){var l={filter:{}};return n.forEach((function(e){"rows"===e.name||"cols"===e.name?l[e.name]=e.value:l.filter[e.name]=e.value})),"rowscols"===t&&e.id.forEach((function(t,n){t!==l.rows&&t!==l.cols?void 0===l.filter[t]&&(l.filter[t]=e.Dimension(n).id[0]):delete l.filter[t]})),l}(a,n.target.parentElement.getAttribute("id"),(l=t,r=[],[].slice.call(l.querySelectorAll("select, input")).forEach((function(e){r.push({name:e.name,value:e.value})})),r)),i)}),!1)})),t.querySelector("a").addEventListener("click",(function(){r.cols=b,r.rows=y,e(t,a,r,i)}),!1)}(r,v,function(e,t){var n,l,a={},r=[],i=e.id;if(t){var o="bigger"===t?function(e,t){return e.len<t.len?1:-1}:function(e,t){return e.len>t.len?1:-1};e.Dimension().forEach((function(e,t){r.push({id:i[t],len:e.length})})),r.sort(o),n=r[0].id,l=r[1].id}else n=i[0],l=i[1];return e.Dimension(n).length<e.Dimension(l).length&&(n=l+(l=n,"")),i.forEach((function(t){t!==n&&t!==l&&(a[t]=e.Dimension(t).id[0])})),{rows:n,cols:l,filter:a}}(v,i.preset),f):o("dimerror")}else o("jsonerror")}else o("selerror");else o("urierror")}function r(n,l){if(void 0===n)return null;void 0===l&&(l={});var a="",r="",i=0,o=l.na||"n/a",s=l.dsid||0,u=l.vlabel||null,c=l.slabel||null,d=l.counter||!1,f=l.tblclass||"",h=l.numclass||"",v=l.valclass||"",p=l.status||!1,b=l.locale||"en-US",g=l.source||"Source",m=e(n,s),y=Number.toLocaleString?function(e){return e.toLocaleString(b)}:function(e){return e},O=d?function(e,t){a+=t?'<tr><td class="'+h+'">'+t+"</td>":'<tr><th class="'+h+'">#</th>',e.forEach((function(e,n){var l=E===n?' class="'+h+" "+v+'"':"",r=null===e?o:y(e);a+=t?"<td"+l+">"+r+"</td>":"<th"+l+">"+r+"</th>"})),a+="</tr>"}:function(e,t){a+="<tr>",e.forEach((function(e,n){var l=E===n?' class="'+h+" "+v+'"':"",r=null===e?o:y(e);a+=t?"<td"+l+">"+r+"</td>":"<th"+l+">"+r+"</th>"})),a+="</tr>"};if(!t(m))return null;var w=m.toTable({status:p,vlabel:u,slabel:c}),E=w[0].length-1;return w.forEach((function(e,t){O(e,t)})),m.source&&(i=m.length+1,d&&i++,p&&i++,"."!==(g+=": "+m.source).slice(-1)&&(g+="."),r='<tfoot><td colspan="'+i+'">'+g+"</td></tfoot>"),'<table class="'+f+'"><caption>'+(l.caption||m.label||"")+"</caption>"+r+"<tbody>"+a+"</tbody></table>"}function i(e,t){var n={};return Array.isArray(e[t])?(e[t].forEach((function(e,t){null!==e&&(n[String(t)]=e)})),n):e[t]}function o(e,t){if(void 0===e)return null;void 0===t&&(t={}),"boolean"!=typeof t.ovalue&&(t.ovalue=!1),"boolean"!=typeof t.ostatus&&(t.ostatus=!1),"boolean"!=typeof t.instance&&(t.instance=!1);var n=t.vlabel||"Value",l=t.slabel||"Status",a=t.type||"array",r=t.label||"",o=t.header||null,s=[],u=[],c=[],d=[],f={},h={},v=function(e,t){for(var n=1,l=0,a=0;a<w;a++)l+=(n*=a>0?t[w-a]:1)*e[w-a-1];return l},p=function(){var t=e[E][n];c[v(S,u)]=isNaN(t)?null:t};switch(a){case"array":e=function(e){for(var t=e[0],n=e.slice(1),l=[],a=0,r=n.length;a<r;a++){for(var i=0,o=t.length,s={};i<o;i++)s[t[i]]=n[a][i];l.push(s)}return l}(e);break;case"object":e=function(e){for(var t=e.cols.map((function(e){return e.id})),n=e.rows,l=[],a=0,r=n.length;a<r;a++){for(var i=0,o=t.length,s={};i<o;i++)s[t[i]]=n[a].c[i].v;l.push(s)}return l}(e)}var b,g=e.length;for(var m in t.hasOwnProperty("drop")&&Array.isArray(t.drop)&&t.drop.length&&e.forEach((function(e){t.drop.forEach((function(t){delete e[t]}))})),e[0])if(m!==n)if(m!==l){if(s.push(m),o)b=o.dimension[m],f[m]=b.category.index;else{f[m]=[];for(var y=0;y<g;y++){var O=e[y][m];-1===f[m].indexOf(O)&&f[m].push(O)}}u.push(f[m].length),h[m]={label:o?b.label:m,category:{index:f[m]}},o&&(h[m].category.label=b.category.label,b.category.unit&&(h[m].category.unit=b.category.unit))}else p=function(){var t=e[E][n],a=e[E][l];c[v(S,u)]=isNaN(t)?null:t,d[v(S,u)]=""===a?null:a};for(var w=s.length,E=0;E<g;E++){for(var S=[],x=0;x<w;x++){var A=s[x];S.push(f[A].indexOf(e[E][A]))}p()}var D={version:"2.0",class:"dataset",value:c,dimension:h,id:s,size:u};return r&&(D.label=r),d.length&&(D.status=d),o&&(o.label&&(D.label=o.label),o.source&&(D.source=o.source),o.updated&&(D.updated=o.updated),o.href&&(D.href=o.href),o.role&&(D.role=o.role)),t.ovalue&&(D.value=i(D,"value")),t.ostatus&&D.hasOwnProperty("status")&&(D.status=i(D,"status")),t.instance?JSONstat(D):D}function s(e,t){if(void 0===e)return null;void 0===t&&(t={});var n,l,a,r=[],i=null,s=null,u=!1,c={time:[],geo:[],metric:[]},d="jsonstat"===e.substring(0,8),f=d?"value":t.vlabel,h=d?"status":t.slabel,v=d?e.substring(8,9):t.delimiter||",",p=";"===v?t.decimal||",":t.decimal||".",b=function(e,t){t=t||",";for(var n,l,a=new RegExp("(\\"+t+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+t+"\\r\\n]*))","gi"),r=[[]],i=null;i=a.exec(e);)(l=i[1]).length&&l!=t&&r.push([]),n=i[2]?i[2].replace(new RegExp('""',"g"),'"'):i[3],r[r.length-1].push(n);return r}(e.trim(),v);if(d){for(p=b[0][1],a=b[0][2],b.shift();"data"!==b[0][0];)r.push(b.shift());b.shift(),s={dimension:{}},r.forEach((function(e){var t,n,l,r,i,o,d,f;switch(e[0]){case"dimension":if(s.dimension[e[1]]={},(r=s.dimension[e[1]]).label=e[2],r.category={},(i=r.category).index=[],n={},l=2*e[3]+3,e.length>=l){for(t=4;t<l;t++)d=e[t],f=e[++t],Object.defineProperty(n,d,{value:f,writable:!0,configurable:!0,enumerable:!0}),i.label=n,i.index.push(d);"string"==typeof e[t]&&-1!==["time","geo","metric"].indexOf(e[t])&&(c[e[t]].push(e[1]),u=!0,"metric"===e[t]&&"string"==typeof e[++t]&&(i.unit={},i.index.forEach((function(n,l){var r=e[t+l].split(a);i.unit[n]={},o=i.unit[n],void 0!==r[0]&&""!==r[0]&&(o.decimals=1*r[0]),void 0!==r[1]&&""!==r[1]&&(o.label=r[1]),void 0!==r[2]&&""!==r[2]&&(o.symbol=r[2]),void 0!==r[1]&&-1!==["start","end"].indexOf(r[3])&&(o.position=r[3])}))))}break;case"label":case"source":case"updated":case"href":s[e[0]]=e[1]||null}})),u&&(c.time.length||delete c.time,c.geo.length||delete c.geo,c.metric.length||delete c.metric,s.role=c)}if(n=b.length,l=b[0].length,void 0!==f){for(;l--;)if(b[0][l]===f){i=l;break}if(null===i)return null}else i=l-1,f=b[0][i];if(","===p)for(l=1;l<n;l++)b[l][i]=Number(b[l][i].replace(",","."));else for(l=1;l<n;l++)b[l][i]=Number(b[l][i]);return o(b,{header:s,vlabel:f,slabel:h,type:"array",label:t.label||"",ovalue:t.ovalue||!1,ostatus:t.ostatus||!1,instance:t.instance||!1})}function u(e,t){if("object"!=typeof e||!e.hasOwnProperty("dataSets")||!Array.isArray(e.dataSets))return null;if(1!==e.dataSets.length)return null;if(!e.dataSets[0].hasOwnProperty("observations"))return null;void 0===t?t={ovalue:!1,ostatus:!1,instance:!1}:("boolean"!=typeof t.ovalue&&(t.ovalue=!1),"boolean"!=typeof t.ostatus&&(t.ostatus=!1),"boolean"!=typeof t.instance&&(t.instance=!1));var n=e.structure,l=e.dataSets[0].observations,a=n.attributes.observation,r=n.dimensions;if(!r.hasOwnProperty("observation"))return null;if(r.hasOwnProperty("series")&&(null!==r.series||Object.keys(r.series).length))return null;var i=[],o=[],s={},u=[],c={time:[],geo:[]},d=function(){},f=function(e,t){for(var n=e.size,l=n.length-t.length;l--;)t.push(0);for(var a=0,r=n.length,i=0,o=1;a<r;a++)i+=(o*=a>0?n[r-a]:1)*t[r-a-1];return i},h=function(e){if(s[e.id]={label:e.name},e.hasOwnProperty("role"))switch(e.role){case"REF_AREA":c.geo.push(e.id);break;case"TIME_PERIOD":c.time.push(e.id)}Object.defineProperty(s[e.id],"category",{value:{index:[],label:{}},writable:!0,enumerable:!0}),i.push(e.id),o.push(e.values.length);var t=s[e.id].category;e.values.forEach((function(e){t.index.push(e.id),Object.defineProperty(t.label,e.id,{value:e.name,writable:!0,enumerable:!0})}))},v=e.header.links.find((function(e){return"request"===e.rel})),p=a.findIndex((function(e){return"OBS_STATUS"===e.id}));-1!==p&&(a[p].values.length?u=a[p].values:p=-1),r.observation.forEach(h),r.hasOwnProperty("dataSet")&&r.dataSet.forEach(h);var b,g={version:"2.0",class:"dataset",updated:e.header.prepared||null,source:e.header.sender.name||null,label:n.name||null,id:i,size:o,dimension:s,value:t.ovalue?{}:[]};for(var m in v&&(g.link={alternate:[{type:"application/vnd.sdmx.data+json",href:v.href}]}),c.geo.length+c.time.length>0&&(c.time.length||delete c.time,c.geo.length||delete c.geo,g.role=c),-1!==p&&(g.status=t.ostatus?{}:[],g.extension={status:{label:{}}},u.forEach((function(e){g.extension.status.label[e.id]=e.name})),d=t.ostatus?function(){var e=l[m][p];null!==e&&(g.status[f(g,y)]=u[e].id)}:function(){var e=l[m][p];g.status[f(g,y)]=null===e?null:u[e].id}),p++,l){var y=m.split(":");t.ovalue&&null===l[m][0]||(g.value[f(g,y)]=l[m][0]),d()}if(!t.ovalue)for(b=o.reduce((function(e,t){return e*t}))-g.value.length;b--;)g.value.push(null);if(!t.ostatus&&g.hasOwnProperty("status"))for(b=o.reduce((function(e,t){return e*t}))-g.status.length;b--;)g.status.push(null);return t.instance?JSONstat(g):g}function c(e,t){if(void 0===e||!Array.isArray(e))return null;var n=JSON.parse(JSON.stringify(e)),l=n[0];if(!l.hasOwnProperty("version")||!l.hasOwnProperty("class")||"dataset"!==l.class)return null;void 0===t&&(t={});var a=void 0===t.label?null:t.label,r=void 0===t.by?null:t.by,i=[];if(null===r){for(var o=1,s=n.length;o<s;o++)i=i.concat(n[o].value);return l.value=i,null!==a&&(l.label=a),l}var u,c,d,f=function(e,t,n){if(Array.isArray(e))e=e.concat(t);else for(var l in t)e[l]=0===t[l]?n:t[l];return e};n.forEach((function(e,t){var n=JSONstat(e).toTable({status:!0}),l=e.dimension[r].category;0===t?(i=[n[0]],u=l.index,c=l.label,d=l.unit):(u=f(u,l.index,t),c=f(c,l.label,t),d=f(d,l.unit,t)),i=i.concat(n.slice(1))}));var h=fromTable(i);return l.value=h.value,l.size=h.size,l.status=h.status||null,l.label=a||"",l.href=null,l.dimension[r].category.index=u||null,l.dimension[r].category.label=c||null,l.dimension[r].category.unit=d||null,l}function d(e,t){return null==e?"":-1!==e.indexOf(t)?'"'+e+'"':e}function f(n,l){if(void 0===n)return null;void 0===l&&(l={});var a="",r="jsonstat",i=!0===l.rich,o=i?"value":l.vlabel||"Value",s=i?"status":l.slabel||"Status",u=!0===l.status,c=l.na||"n/a",f=l.delimiter||",",h=l.separator||"|",v=";"===f?l.decimal||",":l.decimal||".",p=e(n,l.dsid||0);if(!t(p))return null;i&&(u=null!==p.status);var b=p.toTable({vlabel:o,slabel:s,status:u,field:i?"id":"label",content:i?"id":"label",type:"array"}),g=b[0].indexOf(o),m=u?b[0].indexOf(s):-1;return b.forEach((function(e,t){e.forEach((function(n,l){t&&l===g?null===n?e[l]=d(c,f):"."!==v&&(e[l]=String(e[l]).replace(".",v)):e[l]=t&&l===m&&null===n?"":d(e[l],f)})),a+=e.join(f)+"\n"})),i&&(r+=f+v+f+h+"\n",["label","source","updated","href"].forEach((function(e){p[e]&&(r+=e+f+d(p[e],f)+"\n")})),p.id.forEach((function(e,t){var n=[],l=p.Dimension(t),a=l.role,i=!1;r+="dimension"+f+d(e,f)+f+d(l.label,f)+f+l.length,"metric"===a&&l.__tree__.category.unit&&(i=!0),l.id.forEach((function(e,t){var a=[],o=l.Category(t);r+=f+d(e,f)+f+d(o.label,f),i&&(a.push(o.unit.hasOwnProperty("decimals")?o.unit.decimals:""),a.push(o.unit.label||""),o.unit.symbol&&(a.push(o.unit.symbol),a.push(o.unit.position)),n.push(d(a.join(h),f)))})),null!==a&&"classification"!==a&&(r+=f+l.role,i&&(r+=f+n.join(f))),r+="\n"})),a=r+"data\n"+a),a}String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};var h="3.0.0";export{r as datalist,s as fromCSV,u as fromSDMX,o as fromTable,c as join,a as tbrowser,f as toCSV,h as version};
