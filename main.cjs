// jsonstat-suite v3.0.2 Copyright 2019 Xavier Badosa https://jsonstat.com
"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var JSONstat=_interopDefault(require("jsonstat-toolkit"));function dataset(e,t){return null==e?null:("string"!=typeof e&&void 0!==e.length||(e=JSONstat(e)),0===e.length||"dataset"!==e.class&&"collection"!==e.class&&"bundle"!==e.class?null:"dataset"===e.class?e:e.Dataset(t))}function checkds(e){if(null===e||0===e.length||"dataset"!==e.class)return!1;for(var t=e.length,n=1;t--;)n*=e.Dimension(t).length;return n===e.n}function objectify(e,t,n){var r={filter:{}};return n.forEach((function(e){"rows"===e.name||"cols"===e.name?r[e.name]=e.value:r.filter[e.name]=e.value})),"rowscols"===t&&e.id.forEach((function(t,n){t!==r.rows&&t!==r.cols?void 0===r.filter[t]&&(r.filter[t]=e.Dimension(n).id[0]):delete r.filter[t]})),r}function setup(e,t){var n,r,a={},l=[],i=e.id;if(t){var o="bigger"===t?function(e,t){return e.len<t.len?1:-1}:function(e,t){return e.len>t.len?1:-1};e.Dimension().forEach((function(e,t){l.push({id:i[t],len:e.length})})),l.sort(o),n=l[0].id,r=l[1].id}else n=i[0],r=i[1];return e.Dimension(n).length<e.Dimension(r).length&&(n=r+(r=n,"")),i.forEach((function(t){t!==n&&t!==r&&(a[t]=e.Dimension(t).id[0])})),{rows:n,cols:r,filter:a}}function pairs(e){var t=[];return[].slice.call(e.querySelectorAll("select, input")).forEach((function(e){t.push({name:e.name,value:e.value})})),t}function labelize(e,t,n){var r,a,l,i,o;return(t.label||n).capitalize()+(a=t,o="",(r=e)&&"metric"===r.role&&a.unit&&(l=a.unit.hasOwnProperty("label")?a.unit.label:"")+(i=a.unit.hasOwnProperty("symbol")?a.unit.symbol:"")!==""&&(o=" ("+(o=""===i?l:""===l?i:"start"===a.unit.position?i+l:l+" "+i)+")"),o)}function select(e,t,n){var r,a='<select name="'+t+'">',l=[];if(null!==n[1]){if(r=e.id,l=e.Dimension(),2===r.length)return(e.Dimension(n[0]).label||n[0]).capitalize()}else{var i=e.Dimension(t);if(r=i.id,l=i.Category(),1===r.length)return}return r.forEach((function(e,t){var r=e!==n[0]?"":'selected="selected" ';null!==n[1]&&e===n[1]||(a+="<option "+r+'value="'+e+'">'+labelize(i,l[t],e)+"</option>")})),a+="</select>"}function killconst(e){var t=0,n=e.size.slice(0),r=[];return n.forEach((function(n,a){var l=a-t,i=e.Dimension(l);1===n&&(delete e.__tree__.dimension[e.id[l]],e.size.splice(l,1),e.id.splice(l,1),e.length--,t++,r.push(i.label.capitalize()+": "+i.Category(0).label.capitalize()))})),r}function tbrowser(e,t,n){function r(e){void 0!==t?t.innerHTML=a[e]:window.alert(a[e])}if(void 0!==e)if(void 0!==t){void 0===n&&(n={});var a=void 0===n.i18n||void 0===n.i18n.msgs?{urierror:"tbrowser: A valid JSON-stat input must be specified.",selerror:"tbrowser: A valid selector must be specified.",jsonerror:"The request did not return a valid JSON-stat dataset.",dimerror:"Only one dimension was found in the dataset. At least two are required.",dataerror:"Selection returned no data!",source:"Source",filters:"Filters",constants:"Constants",rc:"Rows &amp; Columns",na:"n/a"}:n.i18n.msgs,l=void 0===n.i18n||void 0===n.i18n.locale?"en-US":n.i18n.locale,i=n.dsid||0,o=n.status||!1,s=n.tblclass||"",u=n.nonconst||!1,c=dataset(e,i);if(checkds(c)){if(u)var d=killconst(c);1!==c.length?function e(t,n,r,i){var s="",c="",f="",h="",v=r.rows,p=n.Dimension(v),b=p.id,m=r.cols,g=n.Dimension(m),y=g.id,S=n.role&&n.role.metric?n.role.metric[0]:null,w=null!==S?n.Dimension(S):null,O=function(e){return e.hasOwnProperty("unit")&&e.unit&&e.unit.hasOwnProperty("decimals")?e.unit.decimals:null},E=r.filter,x=JSON.parse(JSON.stringify(E)),j=[],D="",A="",P=n.source?a.source+": "+n.source:"",z=null!==n.label?'<span class="label">'+n.label.capitalize()+"</span>":"";for(var C in u&&d.length&&(z='<span class="label">'+d.join(". ")+"</span>"),""!==P&&"."!==P.slice(-1)&&(P+="."),f+="<caption>"+z+"<form>",E){var N=n.Dimension(C),T=N.label?N.label.capitalize():C.capitalize();N.length>1?D+="<p>"+select(n,C,[E[C],null])+" <strong>"+T+"</strong></p>":j.push({label:T,value:labelize(N,N.Category(0)),name:C,id:N.id[0]})}""!==D&&(D='<fieldset id="filters"><legend>'+a.filters+"</legend>"+D+"</fieldset>"),j.forEach((function(e){A+="<p>"+e.value+" <strong>"+e.label+'</strong></p><input type="hidden" name="'+e.name+'" value="'+e.id+'" />'})),""!==A&&(A='<fieldset id="constants"><legend>'+a.constants+"</legend>"+A+"</fieldset>"),f+=A+D+'<fieldset id="rowscols"><legend>'+a.rc+"</legend>"+select(n,"rows",[v,m])+" <a>&#x2194;</a> "+select(n,"cols",[m,v])+"</fieldset></form></caption>",h+="<tbody>";var k=Number.toLocaleString?function(e,t){return null===t?e.toLocaleString(l):e.toLocaleString(l,{minimumFractionDigits:t,maximumFractionDigits:t})}:function(e,t){return null===t?e:e.toFixed(t)};if(b.forEach((function(e){x[v]=e;var t=n.Data(x),r=function(e,t){var n,r=m!==S?null===w?null:O(w.Category(x[S])):O(g.Category(t));null!==e.value?(n=k(e.value,r),o&&null!==e.status&&(n+=" ("+e.status+")")):n=e.status||a.na,h+="<td>"+n+"</td>"};null!==t?(h+='<tr><th scope="row">'+labelize(p,p.Category(e))+"</th>",Array.isArray(t)?t.forEach((function(e,t){r(e,t)})):r(t,0),h+="</tr>"):h="ERROR"})),"ERROR"===h)return a.dataerror;h+="</tbody>",s+="<thead><tr><th></th>",y.forEach((function(e){s+='<th scope="col">'+labelize(g,g.Category(e))+"</th>"})),s+="</tr></thead>",""!==P&&(c='<tfoot><tr><td colspan="'+(y.length+1)+'">'+P+"</td></tr></tfoot>"),t.innerHTML='<table class="'+i+'">'+f+s+c+h+"</table>",[].slice.call(t.querySelectorAll("select")).forEach((function(r){r.addEventListener("change",(function(r){e(t,n,objectify(n,r.target.parentElement.getAttribute("id"),pairs(t)),i)}),!1)})),t.querySelector("a").addEventListener("click",(function(){r.cols=v,r.rows=m,e(t,n,r,i)}),!1)}(t,c,setup(c,n.preset),s):r("dimerror")}else r("jsonerror")}else r("selerror");else r("urierror")}function datalist(e,t){if(void 0===e)return null;void 0===t&&(t={});var n="",r="",a=0,l=t.na||"n/a",i=t.dsid||0,o=t.vlabel||null,s=t.slabel||null,u=t.counter||!1,c=t.tblclass||"",d=t.numclass||"",f=t.valclass||"",h=t.status||!1,v=t.locale||"en-US",p=t.source||"Source",b=dataset(e,i),m=Number.toLocaleString?function(e){return e.toLocaleString(v)}:function(e){return e},g=u?function(e,t){n+=t?'<tr><td class="'+d+'">'+t+"</td>":'<tr><th class="'+d+'">#</th>',e.forEach((function(e,r){var a=S===r?' class="'+d+" "+f+'"':"",i=null===e?l:m(e);n+=t?"<td"+a+">"+i+"</td>":"<th"+a+">"+i+"</th>"})),n+="</tr>"}:function(e,t){n+="<tr>",e.forEach((function(e,r){var a=S===r?' class="'+d+" "+f+'"':"",i=null===e?l:m(e);n+=t?"<td"+a+">"+i+"</td>":"<th"+a+">"+i+"</th>"})),n+="</tr>"};if(!checkds(b))return null;var y=b.toTable({status:h,vlabel:o,slabel:s}),S=y[0].length-1;return y.forEach((function(e,t){g(e,t)})),b.source&&(a=b.length+1,u&&a++,h&&a++,"."!==(p+=": "+b.source).slice(-1)&&(p+="."),r='<tfoot><td colspan="'+a+'">'+p+"</td></tfoot>"),'<table class="'+c+'"><caption>'+(t.caption||b.label||"")+"</caption>"+r+"<tbody>"+n+"</tbody></table>"}function arr2obj(e,t){var n={};return Array.isArray(e[t])?(e[t].forEach((function(e,t){null!==e&&(n[String(t)]=e)})),n):e[t]}function fromTable$1(e,t){if(void 0===e)return null;void 0===t&&(t={}),"boolean"!=typeof t.ovalue&&(t.ovalue=!1),"boolean"!=typeof t.ostatus&&(t.ostatus=!1),"boolean"!=typeof t.instance&&(t.instance=!1);var n=t.vlabel||"Value",r=t.slabel||"Status",a=t.type||"array",l=t.label||"",i=t.header||null,o=[],s=[],u=[],c=[],d={},f={},h=function(e,t){for(var n=1,r=0,a=0;a<S;a++)r+=(n*=a>0?t[S-a]:1)*e[S-a-1];return r},v=function(){var t=e[w][n];u[h(O,s)]=isNaN(t)?null:t};switch(a){case"array":e=function(e){for(var t=e[0],n=e.slice(1),r=[],a=0,l=n.length;a<l;a++){for(var i=0,o=t.length,s={};i<o;i++)s[t[i]]=n[a][i];r.push(s)}return r}(e);break;case"object":e=function(e){for(var t=e.cols.map((function(e){return e.id})),n=e.rows,r=[],a=0,l=n.length;a<l;a++){for(var i=0,o=t.length,s={};i<o;i++)s[t[i]]=n[a].c[i].v;r.push(s)}return r}(e)}var p,b=e.length;for(var m in t.hasOwnProperty("drop")&&Array.isArray(t.drop)&&t.drop.length&&e.forEach((function(e){t.drop.forEach((function(t){delete e[t]}))})),e[0])if(m!==n)if(m!==r){if(o.push(m),i)p=i.dimension[m],d[m]=p.category.index;else{d[m]=[];for(var g=0;g<b;g++){var y=e[g][m];-1===d[m].indexOf(y)&&d[m].push(y)}}s.push(d[m].length),f[m]={label:i?p.label:m,category:{index:d[m]}},i&&(f[m].category.label=p.category.label,p.category.unit&&(f[m].category.unit=p.category.unit))}else v=function(){var t=e[w][n],a=e[w][r];u[h(O,s)]=isNaN(t)?null:t,c[h(O,s)]=""===a?null:a};for(var S=o.length,w=0;w<b;w++){for(var O=[],E=0;E<S;E++){var x=o[E];O.push(d[x].indexOf(e[w][x]))}v()}var j={version:"2.0",class:"dataset",value:u,dimension:f,id:o,size:s};return l&&(j.label=l),c.length&&(j.status=c),i&&(i.label&&(j.label=i.label),i.source&&(j.source=i.source),i.updated&&(j.updated=i.updated),i.href&&(j.href=i.href),i.role&&(j.role=i.role)),t.ovalue&&(j.value=arr2obj(j,"value")),t.ostatus&&j.hasOwnProperty("status")&&(j.status=arr2obj(j,"status")),t.instance?JSONstat(j):j}function CSVToArray(e,t){t=t||",";for(var n,r,a=new RegExp("(\\"+t+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+t+"\\r\\n]*))","gi"),l=[[]],i=null;i=a.exec(e);)(r=i[1]).length&&r!=t&&l.push([]),n=i[2]?i[2].replace(new RegExp('""',"g"),'"'):i[3],l[l.length-1].push(n);return l}function fromCSV(e,t){if(void 0===e)return null;void 0===t&&(t={});var n,r,a,l=[],i=null,o=null,s=!1,u={time:[],geo:[],metric:[]},c="jsonstat"===e.substring(0,8),d=c?"value":t.vlabel,f=c?"status":t.slabel,h=c?e.substring(8,9):t.delimiter||",",v=";"===h?t.decimal||",":t.decimal||".",p=CSVToArray(e.trim(),h);if(c){for(v=p[0][1],a=p[0][2],p.shift();"data"!==p[0][0];)l.push(p.shift());p.shift(),o={dimension:{}},l.forEach((function(e){var t,n,r,l,i,c,d,f;switch(e[0]){case"dimension":if(o.dimension[e[1]]={},(l=o.dimension[e[1]]).label=e[2],l.category={},(i=l.category).index=[],n={},r=2*e[3]+3,e.length>=r){for(t=4;t<r;t++)d=e[t],f=e[++t],Object.defineProperty(n,d,{value:f,writable:!0,configurable:!0,enumerable:!0}),i.label=n,i.index.push(d);"string"==typeof e[t]&&-1!==["time","geo","metric"].indexOf(e[t])&&(u[e[t]].push(e[1]),s=!0,"metric"===e[t]&&"string"==typeof e[++t]&&(i.unit={},i.index.forEach((function(n,r){var l=e[t+r].split(a);i.unit[n]={},c=i.unit[n],void 0!==l[0]&&""!==l[0]&&(c.decimals=1*l[0]),void 0!==l[1]&&""!==l[1]&&(c.label=l[1]),void 0!==l[2]&&""!==l[2]&&(c.symbol=l[2]),void 0!==l[1]&&-1!==["start","end"].indexOf(l[3])&&(c.position=l[3])}))))}break;case"label":case"source":case"updated":case"href":o[e[0]]=e[1]||null}})),s&&(u.time.length||delete u.time,u.geo.length||delete u.geo,u.metric.length||delete u.metric,o.role=u)}if(n=p.length,r=p[0].length,void 0!==d){for(;r--;)if(p[0][r]===d){i=r;break}if(null===i)return null}else i=r-1,d=p[0][i];if(","===v)for(r=1;r<n;r++)p[r][i]=Number(p[r][i].replace(",","."));else for(r=1;r<n;r++)p[r][i]=Number(p[r][i]);return fromTable$1(p,{header:o,vlabel:d,slabel:f,type:"array",label:t.label||"",ovalue:t.ovalue||!1,ostatus:t.ostatus||!1,instance:t.instance||!1})}function fromSDMX(e,t){if("object"!=typeof e||!e.hasOwnProperty("dataSets")||!Array.isArray(e.dataSets))return null;if(1!==e.dataSets.length)return null;if(!e.dataSets[0].hasOwnProperty("observations"))return null;void 0===t?t={ovalue:!1,ostatus:!1,instance:!1}:("boolean"!=typeof t.ovalue&&(t.ovalue=!1),"boolean"!=typeof t.ostatus&&(t.ostatus=!1),"boolean"!=typeof t.instance&&(t.instance=!1));var n=e.structure,r=e.dataSets[0].observations,a=n.attributes.observation,l=n.dimensions;if(!l.hasOwnProperty("observation"))return null;if(l.hasOwnProperty("series")&&(null!==l.series||Object.keys(l.series).length))return null;var i=[],o=[],s={},u=[],c={time:[],geo:[]},d=function(){},f=function(e,t){for(var n=e.size,r=n.length-t.length;r--;)t.push(0);for(var a=0,l=n.length,i=0,o=1;a<l;a++)i+=(o*=a>0?n[l-a]:1)*t[l-a-1];return i},h=function(e){if(s[e.id]={label:e.name},e.hasOwnProperty("role"))switch(e.role){case"REF_AREA":c.geo.push(e.id);break;case"TIME_PERIOD":c.time.push(e.id)}Object.defineProperty(s[e.id],"category",{value:{index:[],label:{}},writable:!0,enumerable:!0}),i.push(e.id),o.push(e.values.length);var t=s[e.id].category;e.values.forEach((function(e){t.index.push(e.id),Object.defineProperty(t.label,e.id,{value:e.name,writable:!0,enumerable:!0})}))},v=e.header.links.find((function(e){return"request"===e.rel})),p=a.findIndex((function(e){return"OBS_STATUS"===e.id}));-1!==p&&(a[p].values.length?u=a[p].values:p=-1),l.observation.forEach(h),l.hasOwnProperty("dataSet")&&l.dataSet.forEach(h);var b,m={version:"2.0",class:"dataset",updated:e.header.prepared||null,source:e.header.sender.name||null,label:n.name||null,id:i,size:o,dimension:s,value:t.ovalue?{}:[]};for(var g in v&&(m.link={alternate:[{type:"application/vnd.sdmx.data+json",href:v.href}]}),c.geo.length+c.time.length>0&&(c.time.length||delete c.time,c.geo.length||delete c.geo,m.role=c),-1!==p&&(m.status=t.ostatus?{}:[],m.extension={status:{label:{}}},u.forEach((function(e){m.extension.status.label[e.id]=e.name})),d=t.ostatus?function(){var e=r[g][p];null!==e&&(m.status[f(m,y)]=u[e].id)}:function(){var e=r[g][p];m.status[f(m,y)]=null===e?null:u[e].id}),p++,r){var y=g.split(":");t.ovalue&&null===r[g][0]||(m.value[f(m,y)]=r[g][0]),d()}if(!t.ovalue)for(b=o.reduce((function(e,t){return e*t}))-m.value.length;b--;)m.value.push(null);if(!t.ostatus&&m.hasOwnProperty("status"))for(b=o.reduce((function(e,t){return e*t}))-m.status.length;b--;)m.status.push(null);return t.instance?JSONstat(m):m}function join(e,t){if(void 0===e||!Array.isArray(e))return null;var n=JSON.parse(JSON.stringify(e)),r=n[0];if(!r.hasOwnProperty("version")||!r.hasOwnProperty("class")||"dataset"!==r.class)return null;void 0===t&&(t={});var a=void 0===t.label?null:t.label,l=void 0===t.by?null:t.by,i=[];if(null===l){for(var o=1,s=n.length;o<s;o++)i=i.concat(n[o].value);return r.value=i,null!==a&&(r.label=a),r}var u,c,d,f=function(e,t,n){if(Array.isArray(e))e=e.concat(t);else for(var r in t)e[r]=0===t[r]?n:t[r];return e};n.forEach((function(e,t){var n=JSONstat(e).toTable({status:!0}),r=e.dimension[l].category;0===t?(i=[n[0]],u=r.index,c=r.label,d=r.unit):(u=f(u,r.index,t),c=f(c,r.label,t),d=f(d,r.unit,t)),i=i.concat(n.slice(1))}));var h=fromTable(i);return r.value=h.value,r.size=h.size,r.status=h.status||null,r.label=a||"",r.href=null,r.dimension[l].category.index=u||null,r.dimension[l].category.label=c||null,r.dimension[l].category.unit=d||null,r}function dcomma(e,t){return null==e?"":-1!==e.indexOf(t)?'"'+e+'"':e}function toCSV(e,t){if(void 0===e)return null;void 0===t&&(t={});var n="",r="jsonstat",a=!0===t.rich,l=a?"value":t.vlabel||"Value",i=a?"status":t.slabel||"Status",o=!0===t.status,s=t.na||"n/a",u=t.delimiter||",",c=t.separator||"|",d=";"===u?t.decimal||",":t.decimal||".",f=dataset(e,t.dsid||0);if(!checkds(f))return null;a&&(o=null!==f.status);var h=f.toTable({vlabel:l,slabel:i,status:o,field:a?"id":"label",content:a?"id":"label",type:"array"}),v=h[0].indexOf(l),p=o?h[0].indexOf(i):-1;return h.forEach((function(e,t){e.forEach((function(n,r){t&&r===v?null===n?e[r]=dcomma(s,u):"."!==d&&(e[r]=String(e[r]).replace(".",d)):e[r]=t&&r===p&&null===n?"":dcomma(e[r],u)})),n+=e.join(u)+"\n"})),a&&(r+=u+d+u+c+"\n",["label","source","updated","href"].forEach((function(e){f[e]&&(r+=e+u+dcomma(f[e],u)+"\n")})),f.id.forEach((function(e,t){var n=[],a=f.Dimension(t),l=a.role,i=!1;r+="dimension"+u+dcomma(e,u)+u+dcomma(a.label,u)+u+a.length,"metric"===l&&a.__tree__.category.unit&&(i=!0),a.id.forEach((function(e,t){var l=[],o=a.Category(t);r+=u+dcomma(e,u)+u+dcomma(o.label,u),i&&(l.push(o.unit.hasOwnProperty("decimals")?o.unit.decimals:""),l.push(o.unit.label||""),o.unit.symbol&&(l.push(o.unit.symbol),l.push(o.unit.position)),n.push(dcomma(l.join(c),u)))})),null!==l&&"classification"!==l&&(r+=u+a.role,i&&(r+=u+n.join(u))),r+="\n"})),n=r+"data\n"+n),n}String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};var version="3.0.2";exports.datalist=datalist,exports.fromCSV=fromCSV,exports.fromSDMX=fromSDMX,exports.fromTable=fromTable$1,exports.join=join,exports.tbrowser=tbrowser,exports.toCSV=toCSV,exports.version=version;
