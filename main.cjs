// jsonstat-suite v3.2.3 Copyright 2021 Xavier Badosa https://jsonstat.com
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=(e=require("jsonstat-toolkit"))&&"object"==typeof e&&"default"in e?e.default:e;function n(e,n){return null==e?null:("string"!=typeof e&&void 0!==e.length||(e=t(e)),0===e.length||"dataset"!==e.class&&"collection"!==e.class&&"bundle"!==e.class?null:"dataset"===e.class?e:e.Dataset(n))}function r(e){if(null===e||0===e.length||"dataset"!==e.class)return!1;for(var t=e.length,n=1;t--;)n*=e.Dimension(t).length;return n===e.n}function l(e,t,n){var r,l,a,i,o;return(t.label||n).capitalize()+(l=t,o="",(r=e)&&"metric"===r.role&&l.unit&&(a=l.unit.hasOwnProperty("label")?l.unit.label:"")+(i=l.unit.hasOwnProperty("symbol")?l.unit.symbol:"")!==""&&(o=" ("+(o=""===i?a:""===a?i:"start"===l.unit.position?i+a:a+" "+i)+")"),o)}function a(e,t,n){var r,a='<select name="'+t+'">',i=[];if(null!==n[1]){if(r=e.id,i=e.Dimension(),2===r.length)return(e.Dimension(n[0]).label||n[0]).capitalize()}else{var o=e.Dimension(t);if(r=o.id,i=o.Category(),1===r.length)return}return r.forEach((function(e,t){var r=e!==n[0]?"":'selected="selected" ';null!==n[1]&&e===n[1]||(a+="<option "+r+'value="'+e+'">'+l(o,i[t],e)+"</option>")})),a+="</select>"}function i(e,t){var n={};return Array.isArray(e[t])?(e[t].forEach((function(e,t){null!==e&&(n[String(t)]=e)})),n):e[t]}function o(e,n){if(void 0===e)return null;void 0===n&&(n={}),"boolean"!=typeof n.ovalue&&(n.ovalue=!1),"boolean"!=typeof n.ostatus&&(n.ostatus=!1),"boolean"!=typeof n.instance&&(n.instance=!1);var r=n.vlabel||"Value",l=n.slabel||"Status",a=n.type||"array",o=n.label||"",s=n.header||null,u=[],c=[],d=[],f=[],v={},h={},b=function(e,t){for(var n=1,r=0,l=0;l<O;l++)r+=(n*=l>0?t[O-l]:1)*e[O-l-1];return r},p=function(){var t=e[x][r];d[b(S,c)]=isNaN(t)?null:t};switch(a){case"array":e=function(e){for(var t=e[0],n=e.slice(1),r=[],l=0,a=n.length;l<a;l++){for(var i=0,o=t.length,s={};i<o;i++)s[t[i]]=n[l][i];r.push(s)}return r}(e);break;case"object":e=function(e){for(var t=e.cols.map((function(e){return e.id})),n=e.rows,r=[],l=0,a=n.length;l<a;l++){for(var i=0,o=t.length,s={};i<o;i++)s[t[i]]=n[l].c[i].v;r.push(s)}return r}(e)}var g,m=e.length;for(var y in n.hasOwnProperty("drop")&&Array.isArray(n.drop)&&n.drop.length&&e.forEach((function(e){n.drop.forEach((function(t){delete e[t]}))})),e[0])if(y!==r)if(y!==l){if(u.push(y),s)g=s.dimension[y],v[y]=g.category.index;else{v[y]=[];for(var w=0;w<m;w++){var E=e[w][y];-1===v[y].indexOf(E)&&v[y].push(E)}}c.push(v[y].length),h[y]={label:s?g.label:y,category:{index:v[y]}},s&&(h[y].category.label=g.category.label,g.category.unit&&(h[y].category.unit=g.category.unit))}else p=function(){var t=e[x][r],n=e[x][l];d[b(S,c)]=isNaN(t)?null:t,f[b(S,c)]=""===n?null:n};for(var O=u.length,x=0;x<m;x++){for(var S=[],A=0;A<O;A++){var D=u[A];S.push(v[D].indexOf(e[x][D]))}p()}var j={version:"2.0",class:"dataset",value:d,dimension:h,id:u,size:c};return o&&(j.label=o),f.length&&(j.status=f),s&&(s.label&&(j.label=s.label),s.source&&(j.source=s.source),s.updated&&(j.updated=s.updated),s.href&&(j.href=s.href),s.role&&(j.role=s.role)),n.ovalue&&(j.value=i(j,"value")),n.ostatus&&j.hasOwnProperty("status")&&(j.status=i(j,"status")),n.instance?t(j):j}function s(e,t){return null==e?"":-1!==e.indexOf(t)?'"'+e+'"':e}String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};exports.datalist=function(e,t){if(void 0===e)return null;void 0===t&&(t={});var l="",a="",i="",o=0,s=t.na||"n/a",u=t.dsid||0,c=t.vlabel||null,d=t.slabel||null,f=t.counter||!1,v=t.tblclass||"",h=t.numclass||"",b=t.valclass||"",p=t.status||!1,g=t.locale||"en-US",m=t.source||"Source",y=n(e,u),w=y.role&&y.role.metric?y.id.indexOf(y.role.metric[0]):null,E=y.Dimension({role:"metric"}),O={},x=Number.toLocaleString&&"none"!==g?function(e,t){return null===t?e.toLocaleString(g):e.toLocaleString(g,{minimumFractionDigits:t,maximumFractionDigits:t})}:function(e,t){return null===t?e:e.toFixed(t)},S=function(e,t){var n=null;e.forEach((function(e,r){var i=j===r?' class="'+h+" "+b+'"':"",o=s;t?(w===r&&(n=O[e]),null!==e&&(o=j===r?x(e,n):e),a+="<td"+i+">"+o+"</td>"):l+="<th"+i+">"+e+"</th>"}))},A=f?function(e,t){t?a+='<tr><td class="'+h+'">'+t+"</td>":l+='<th class="'+h+'">#</th>',S(e,t),a+="</tr>"}:function(e,t){a+="<tr>",S(e,t),a+="</tr>"};if(!r(y))return null;E&&E[0].Category().forEach((function(e){var t=e.unit&&e.unit.hasOwnProperty("decimals")?e.unit.decimals:null;O[e.label]=t}));var D=y.toTable({status:p,vlabel:c,slabel:d}),j=D[0].length-1;return D.forEach((function(e,t){A(e,t)})),y.source&&(o=y.length+1,f&&o++,p&&o++,"."!==(m+=": "+y.source).slice(-1)&&(m+="."),i='<tfoot><td colspan="'+o+'">'+m+"</td></tfoot>"),'<table class="'+v+'"><caption>'+(t.caption||y.label||"")+"</caption><thead><tr>"+l+"</tr></thead><tbody>"+a+"</tbody>"+i+"</table>"},exports.fromCSV=function(e,t){if(void 0===e)return null;void 0===t&&(t={});var n,r,l,a=[],i=null,s=null,u=!1,c={time:[],geo:[],metric:[]},d="jsonstat"===e.substring(0,8),f=d?"value":t.vlabel,v=d?"status":t.slabel,h=d?e.substring(8,9):t.delimiter||",",b=";"===h?t.decimal||",":t.decimal||".",p=function(e,t){t=t||",";for(var n,r,l=new RegExp("(\\"+t+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+t+"\\r\\n]*))","gi"),a=[[]],i=null;i=l.exec(e);)(r=i[1]).length&&r!=t&&a.push([]),n=i[2]?i[2].replace(new RegExp('""',"g"),'"'):i[3],a[a.length-1].push(n);return a}(e.trim(),h);if(d){for(b=p[0][1],l=p[0][2],p.shift();"data"!==p[0][0];)a.push(p.shift());p.shift(),s={dimension:{}},a.forEach((function(e){var t,n,r,a,i,o,d,f;switch(e[0]){case"dimension":if(s.dimension[e[1]]={},(a=s.dimension[e[1]]).label=e[2],a.category={},(i=a.category).index=[],n={},r=2*e[3]+3,e.length>=r){for(t=4;t<r;t++)d=e[t],f=e[++t],Object.defineProperty(n,d,{value:f,writable:!0,configurable:!0,enumerable:!0}),i.label=n,i.index.push(d);"string"==typeof e[t]&&-1!==["time","geo","metric"].indexOf(e[t])&&(c[e[t]].push(e[1]),u=!0,"metric"===e[t]&&"string"==typeof e[++t]&&(i.unit={},i.index.forEach((function(n,r){var a=e[t+r].split(l);i.unit[n]={},o=i.unit[n],void 0!==a[0]&&""!==a[0]&&(o.decimals=1*a[0]),void 0!==a[1]&&""!==a[1]&&(o.label=a[1]),void 0!==a[2]&&""!==a[2]&&(o.symbol=a[2]),void 0!==a[1]&&-1!==["start","end"].indexOf(a[3])&&(o.position=a[3])}))))}break;case"label":case"source":case"updated":case"href":s[e[0]]=e[1]||null}})),u&&(c.time.length||delete c.time,c.geo.length||delete c.geo,c.metric.length||delete c.metric,s.role=c)}if(n=p.length,r=p[0].length,void 0!==f){for(;r--;)if(p[0][r]===f){i=r;break}if(null===i)return null}else i=r-1,f=p[0][i];if(","===b)for(r=1;r<n;r++)p[r][i]=Number(p[r][i].replace(",","."));else for(r=1;r<n;r++)p[r][i]=Number(p[r][i]);return o(p,{header:s,vlabel:f,slabel:v,type:"array",label:t.label||"",ovalue:t.ovalue||!1,ostatus:t.ostatus||!1,instance:t.instance||!1})},exports.fromSDMX=function(e,n){if("object"!=typeof e||!e.hasOwnProperty("dataSets")||!Array.isArray(e.dataSets))return null;if(1!==e.dataSets.length)return null;e.dataSets[0].hasOwnProperty("observations")||function(e){var t=e.dataSets[0],n=t.series,r=e.structure,l=r.dimensions,a={};Object.keys(n).forEach(e=>{var t=n[e].observations;Object.keys(t).forEach(r=>{a[e+":"+r]=t[r].concat(n[e].attributes)})}),t.observations=a,delete t.series,l.observation=l.series.concat(l.observation),delete l.series,r.attributes.observation=r.attributes.observation.concat(r.attributes.series),delete r.attributes.series}(e),void 0===n?n={ovalue:!1,ostatus:!1,instance:!1}:("boolean"!=typeof n.ovalue&&(n.ovalue=!1),"boolean"!=typeof n.ostatus&&(n.ostatus=!1),"boolean"!=typeof n.instance&&(n.instance=!1));var r=e.structure,l=e.dataSets[0].observations,a=r.attributes.observation,i=r.dimensions;if(!i.hasOwnProperty("observation"))return null;if(i.hasOwnProperty("series")&&(null!==i.series||Object.keys(i.series).length))return null;var o=1,s=[],u=[],c={},d=[],f={time:[],geo:[]},v=function(){},h=function(e,t){for(var n=e.size,r=n.length-t.length;r--;)t.push(0);for(var l=0,a=n.length,i=0,o=1;l<a;l++)i+=(o*=l>0?n[a-l]:1)*t[a-l-1];return i},b=function(e){if(c[e.id]={label:e.name},e.hasOwnProperty("role"))switch(e.role){case"REF_AREA":f.geo.push(e.id);break;case"TIME_PERIOD":f.time.push(e.id)}Object.defineProperty(c[e.id],"category",{value:{index:[],label:{}},writable:!0,enumerable:!0}),s.push(e.id),u.push(e.values.length),o*=e.values.length;var t=c[e.id].category;e.values.forEach((function(e){t.index.push(e.id),Object.defineProperty(t.label,e.id,{value:e.name,writable:!0,enumerable:!0})}))},p=e.header.links?e.header.links.find((function(e){return"request"===e.rel})):null,g=a.findIndex((function(e){return"OBS_STATUS"===e.id}));-1!==g&&(a[g].values.length?d=a[g].values:g=-1),i.observation.forEach(b),i.hasOwnProperty("dataSet")&&i.dataSet.forEach(b);var m={version:"2.0",class:"dataset",updated:e.header.prepared||null,source:e.header.sender.name||null,label:r.name||null,id:s,size:u,dimension:c,value:n.ovalue?{}:new Array(o).fill(null)};for(var y in p&&(m.link={alternate:[{type:"application/vnd.sdmx.data+json",href:p.href}]}),f.geo.length+f.time.length>0&&(f.time.length||delete f.time,f.geo.length||delete f.geo,m.role=f),-1!==g&&(m.status=n.ostatus?{}:new Array(o).fill(null),m.extension={status:{label:{}}},d.forEach((function(e){m.extension.status.label[e.id]=e.name})),v=n.ostatus?function(){var e=l[y][g];null!==e&&(m.status[h(m,w)]=d[e].id)}:function(){var e=l[y][g];m.status[h(m,w)]=null===e?null:d[e].id}),g++,l){var w=y.split(":");n.ovalue&&null===l[y][0]||(m.value[h(m,w)]=l[y][0]),v()}return n.instance?t(m):m},exports.fromTable=o,exports.join=function(e,n){if(void 0===e||!Array.isArray(e))return null;var r=JSON.parse(JSON.stringify(e)),l=r[0];if(!l.hasOwnProperty("version")||!l.hasOwnProperty("class")||"dataset"!==l.class)return null;void 0===n&&(n={});var a=void 0===n.label?null:n.label,i=void 0===n.by?null:n.by,s=[];if(null===i){for(var u=1,c=r.length;u<c;u++)s=s.concat(r[u].value);return l.value=s,null!==a&&(l.label=a),l}var d,f,v,h=function(e,t,n){if(Array.isArray(e))e=e.concat(t);else for(var r in t)e[r]=0===t[r]?n:t[r];return e};r.forEach((function(e,n){var r=t(e).toTable({status:!0}),l=e.dimension[i].category;0===n?(s=[r[0]],d=l.index,f=l.label,v=l.unit):(d=function(e,t,n){if(Array.isArray(e))e=e.concat(t);else for(var r in t)e[r]=t[r]+n;return e}(d,l.index,Object.keys(d).length),f=h(f,l.label,n),v=h(v,l.unit,n)),s=s.concat(r.slice(1))}));var b=o(s);return l.value=b.value,l.size=b.size,l.status=b.status||null,l.label=a||"",l.href=null,l.dimension[i].category.index=d||null,l.dimension[i].category.label=f||null,l.dimension[i].category.unit=v||null,l},exports.tbrowser=function(e,t,i){function o(e){void 0!==t?t.innerHTML=s[e]:window.alert(s[e])}if(void 0!==e)if(void 0!==t){void 0===i&&(i={});var s=void 0===i.i18n||void 0===i.i18n.msgs?{urierror:"tbrowser: A valid JSON-stat input must be specified.",selerror:"tbrowser: A valid selector must be specified.",jsonerror:"The request did not return a valid JSON-stat dataset.",dimerror:"Only one dimension was found in the dataset. At least two are required.",dataerror:"Selection returned no data!",source:"Source",filters:"Filters",constants:"Constants",rc:"Rows &amp; Columns",na:"n/a"}:i.i18n.msgs,u=void 0===i.i18n||void 0===i.i18n.locale?"en-US":i.i18n.locale,c=i.dsid||0,d=i.status||!1,f=i.tblclass||"",v=i.nonconst||!1,h=n(e,c);if(r(h)){if(v)var b=function(e){var t=0,n=e.size.slice(0),r=[];return n.forEach((function(n,l){var a=l-t,i=e.Dimension(a);1===n&&(delete e.__tree__.dimension[e.id[a]],e.size.splice(a,1),e.id.splice(a,1),e.length--,t++,r.push(i.label.capitalize()+": "+i.Category(0).label.capitalize()))})),r}(h);1!==h.length?function e(t,n,r,i){var o="",c="",f="",h="",p=r.rows,g=n.Dimension(p),m=g.id,y=r.cols,w=n.Dimension(y),E=w.id,O=n.role&&n.role.metric?n.role.metric[0]:null,x=null!==O?n.Dimension(O):null,S=function(e){return e.hasOwnProperty("unit")&&e.unit&&e.unit.hasOwnProperty("decimals")?e.unit.decimals:null},A=r.filter,D=JSON.parse(JSON.stringify(A)),j=[],P="",z="",C=n.source?s.source+": "+n.source:"",N=null!==n.label?'<span class="label">'+n.label.capitalize()+"</span>":"";for(var k in v&&b.length&&(N='<span class="label">'+b.join(". ")+"</span>"),""!==C&&"."!==C.slice(-1)&&(C+="."),f+="<caption>"+N+"<form>",A){var _=n.Dimension(k),R=_.label?_.label.capitalize():k.capitalize();_.length>1?P+="<p>"+a(n,k,[A[k],null])+" <strong>"+R+"</strong></p>":j.push({label:R,value:l(_,_.Category(0)),name:k,id:_.id[0]})}""!==P&&(P='<fieldset id="filters"><legend>'+s.filters+"</legend>"+P+"</fieldset>"),j.forEach((function(e){z+="<p>"+e.value+" <strong>"+e.label+'</strong></p><input type="hidden" name="'+e.name+'" value="'+e.id+'" />'})),""!==z&&(z='<fieldset id="constants"><legend>'+s.constants+"</legend>"+z+"</fieldset>"),f+=z+P+'<fieldset id="rowscols"><legend>'+s.rc+"</legend>"+a(n,"rows",[p,y])+" <a>&#x2194;</a> "+a(n,"cols",[y,p])+"</fieldset></form></caption>",h+="<tbody>";var L=Number.toLocaleString&&"none"!==u?function(e,t){return null===t?e.toLocaleString(u):e.toLocaleString(u,{minimumFractionDigits:t,maximumFractionDigits:t})}:function(e,t){return null===t?e:e.toFixed(t)};if(m.forEach((function(e){D[p]=e;var t=n.Data(D),r=function(e,t){var n,r=y!==O?null===x?null:S(x.Category(D[O])):S(w.Category(t));null!==e.value?(n=L(e.value,r),d&&null!==e.status&&(n+=" ("+e.status+")")):n=e.status||s.na,h+="<td>"+n+"</td>"};null!==t?(h+='<tr><th scope="row">'+l(g,g.Category(e))+"</th>",Array.isArray(t)?t.forEach((function(e,t){r(e,t)})):r(t,0),h+="</tr>"):h="ERROR"})),"ERROR"===h)return s.dataerror;h+="</tbody>",o+="<thead><tr><th></th>",E.forEach((function(e){o+='<th scope="col">'+l(w,w.Category(e))+"</th>"})),o+="</tr></thead>",""!==C&&(c='<tfoot><tr><td colspan="'+(E.length+1)+'">'+C+"</td></tr></tfoot>"),t.innerHTML='<table class="'+i+'">'+f+o+h+c+"</table>",[].slice.call(t.querySelectorAll("select")).forEach((function(r){r.addEventListener("change",(function(r){var l,a;e(t,n,function(e,t,n){var r={filter:{}};return n.forEach((function(e){"rows"===e.name||"cols"===e.name?r[e.name]=e.value:r.filter[e.name]=e.value})),"rowscols"===t&&e.id.forEach((function(t,n){t!==r.rows&&t!==r.cols?void 0===r.filter[t]&&(r.filter[t]=e.Dimension(n).id[0]):delete r.filter[t]})),r}(n,r.target.parentElement.getAttribute("id"),(l=t,a=[],[].slice.call(l.querySelectorAll("select, input")).forEach((function(e){a.push({name:e.name,value:e.value})})),a)),i)}),!1)})),t.querySelector("a").addEventListener("click",(function(){r.cols=p,r.rows=y,e(t,n,r,i)}),!1)}(t,h,function(e,t){var n,r,l={},a=[],i=e.id;if(t){var o="bigger"===t?function(e,t){return e.len<t.len?1:-1}:function(e,t){return e.len>t.len?1:-1};e.Dimension().forEach((function(e,t){a.push({id:i[t],len:e.length})})),a.sort(o),n=a[0].id,r=a[1].id}else n=i[0],r=i[1];return e.Dimension(n).length<e.Dimension(r).length&&(n=r+(r=n,"")),i.forEach((function(t){t!==n&&t!==r&&(l[t]=e.Dimension(t).id[0])})),{rows:n,cols:r,filter:l}}(h,i.preset),f):o("dimerror")}else o("jsonerror")}else o("selerror");else o("urierror")},exports.toCSV=function(e,t){if(void 0===e)return null;void 0===t&&(t={});var l=!0===t.rich,a=l?"value":t.vlabel||"Value",i=l?"status":t.slabel||"Status",o=!0===t.status,u=t.na||"n/a",c=t.delimiter||",",d=t.separator||"|",f=";"===c?t.decimal||",":t.decimal||".",v=!0===t.array,h=n(e,t.dsid||0),b=v?[]:"",p=v?[]:"",g=v?function(e){b.push(e)}:function(e){b+=e+"\n"},m=v?function(e){p.push(e)}:function(e){p+=e+"\n"};if(!r(h))return null;l&&(o=null!==h.status);var y=h.toTable({vlabel:a,slabel:i,status:o,field:l?"id":"label",content:l?"id":"label",type:"array"}),w=y[0].indexOf(a),E=o?y[0].indexOf(i):-1;return y.forEach((function(e,t){e.forEach((function(n,r){t&&r===w?null===n?e[r]=s(u,c):"."!==f&&(e[r]=String(e[r]).replace(".",f)):e[r]=t&&r===E&&null===n?"":s(e[r],c)})),g(e.join(c))})),l&&(m("jsonstat"+c+f+c+d),["label","source","updated","href"].forEach((function(e){h[e]&&m(e+c+s(h[e],c))})),h.id.forEach((function(e,t){var n=[],r=h.Dimension(t),l=r.role,a=!1,i="";i+="dimension"+c+s(e,c)+c+s(r.label,c)+c+r.length,"metric"===l&&r.__tree__.category.unit&&(a=!0),r.id.forEach((function(e,t){var l=[],o=r.Category(t);i+=c+s(e,c)+c+s(o.label,c),a&&(l.push(o.unit.hasOwnProperty("decimals")?o.unit.decimals:""),l.push(o.unit.label||""),o.unit.symbol&&(l.push(o.unit.symbol),l.push(o.unit.position)),n.push(s(l.join(d),c)))})),null!==l&&"classification"!==l&&(i+=c+r.role,a&&(i+=c+n.join(c))),m(i)})),b=v?p.concat(["data"],b):p+"data\n"+b),b},exports.version="3.2.3";
